[TOC]

## ä»€ä¹ˆæ˜¯ OPC UA

**OPC UA**ï¼ˆOPC Unified Architectureï¼Œå¼€æ”¾å¹³å°é€šä¿¡ç»Ÿä¸€æ¶æ„ï¼‰æ˜¯ OPC åŸºé‡‘ä¼šåº”ç”¨åœ¨è‡ªåŠ¨åŒ–æŠ€æœ¯çš„æœºå™¨å¯¹æœºå™¨ç½‘ç»œä¼ è¾“åå®šã€‚OPC UA ä¸ä¾èµ–äºç‰¹å®šçš„æ“ä½œç³»ç»Ÿæˆ–å¹³å°ï¼Œå¯ä»¥åœ¨ Windowsã€Macã€Linux ç­‰å¤šç§ç³»ç»Ÿä¸Šè¿è¡Œï¼Œè€Œä¼ ç»Ÿçš„ OPCï¼ˆå¦‚ OPC DAï¼‰é€šå¸¸åªèƒ½åœ¨ Windows ä¸Šä½¿ç”¨ã€‚è¯¥åè®®æä¾›äº†ä¸€ä¸ªæ›´ä¸ºå…ˆè¿›ã€å®‰å…¨å’Œçµæ´»çš„è§£å†³æ–¹æ¡ˆï¼Œé€‚ç”¨äºç°ä»£å·¥ä¸šè‡ªåŠ¨åŒ–å’Œç‰©è”ç½‘ç¯å¢ƒä¸­çš„è®¾å¤‡é—´é€šä¿¡ã€‚

![](1.png)

OPC UA é€šè¿‡ä¸€ä¸ªç»Ÿä¸€çš„**ä¿¡æ¯æ¨¡å‹**æ¥å®ç°è®¾å¤‡é—´çš„æ— ç¼æ•°æ®äº¤æ¢ï¼Œä¿¡æ¯æ¨¡å‹æ¥æºäºé¢å‘å¯¹è±¡ç¼–ç¨‹ï¼Œä½¿ç”¨äº†**å¯¹è±¡**ä½œä¸ºè¿‡ç¨‹ç³»ç»Ÿè¡¨ç¤ºæ•°æ®å’Œæ´»åŠ¨çš„åŸºç¡€ã€‚è¿™ä¸ªæ¨¡å‹ç”±**èŠ‚ç‚¹**ç»„æˆï¼ŒèŠ‚ç‚¹å¯ä»¥æ˜¯å¯¹è±¡ã€å˜é‡æˆ–æ–¹æ³•ï¼Œå®ƒä»¬é€šè¿‡**å¼•ç”¨**ç›¸äº’è¿æ¥ï¼Œæ„æˆäº†ä¸€ä¸ªå¤æ‚çš„ç½‘ç»œã€‚æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸€ç»„å±æ€§å’Œå¼•ç”¨ï¼Œç”¨äºæè¿°æ•°æ®å’Œå®šä¹‰èŠ‚ç‚¹é—´çš„å…³ç³»ã€‚OPC UA çš„**åœ°å€ç©ºé—´**å°±æ˜¯è¿™æ ·ä¸€ä¸ªèŠ‚ç‚¹ç½‘ç»œï¼Œå®ƒä¸ºå®¢æˆ·ç«¯æä¾›äº†ä¸€ç§æ ‡å‡†åŒ–çš„æ–¹å¼æ¥è®¿é—®æœåŠ¡å™¨ä¸Šçš„å¯¹è±¡ã€‚OPC UA è¿˜æä¾›äº†ä¸€ç³»åˆ—æœåŠ¡ï¼Œä½¿å®¢æˆ·ç«¯èƒ½å¤Ÿæ‰§è¡Œè¯»å–ã€å†™å…¥å’Œè®¢é˜…ç­‰æ“ä½œã€‚å®‰å…¨æ€§ä¹Ÿæ˜¯ OPC UA è®¾è®¡çš„æ ¸å¿ƒï¼Œå†…ç½®äº†å¤šç§å®‰å…¨æœºåˆ¶ï¼ŒåŒ…æ‹¬è®¤è¯ã€æˆæƒã€åŠ å¯†å’Œæ¶ˆæ¯ç­¾åï¼Œä»¥ç¡®ä¿æ•°æ®ä¼ è¾“çš„å®‰å…¨æ€§ã€‚

![](11.png)

## UaExpert çš„ä½¿ç”¨

UaExpert æ˜¯ä¸€æ¬¾ OPC UA å®¢æˆ·ç«¯è½¯ä»¶ï¼Œç”¨äºè¿æ¥ OPC UA æœåŠ¡å™¨å¹¶ä¸ä¹‹äº¤äº’ã€‚UaExpert æ”¯æŒ OPC UA çš„æ‰€æœ‰ç‰¹æ€§ï¼ŒåŒ…æ‹¬æ•°æ®è§†å›¾ã€æŠ¥è­¦è§†å›¾ã€å†å²è¶‹åŠ¿è§†å›¾å’Œè¯Šæ–­è§†å›¾ç­‰åŠŸèƒ½ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡ UaExpert è®¿é—®æœåŠ¡å™¨ä¸Šçš„èŠ‚ç‚¹ï¼Œå¦‚è®¾å¤‡å’Œä¼ æ„Ÿå™¨ï¼Œä»¥åŠå®ƒä»¬çš„å±æ€§ï¼Œä¾‹å¦‚æ¸©åº¦ã€å‹åŠ›ç­‰æ•°æ®ã€‚UaExpert è¿˜æä¾›äº†ä»¿çœŸã€é…ç½®ã€å†å²åŠŸèƒ½æµ‹è¯•å’Œå¯¼å‡ºèŠ‚ç‚¹çš„åŠŸèƒ½ï¼Œå¤§å¤šæ•°åŠŸèƒ½éƒ½æ˜¯å…è´¹ä½¿ç”¨çš„ã€‚

### ä¸‹è½½ UaExpert

è®¿é—® [Unified Automation](https://www.unified-automation.com/downloads/opc-ua-clients/uaexpert.html) çš„å®˜ç½‘ä¸‹è½½ UaExpertï¼Œæœªæ³¨å†Œç”¨æˆ·åˆ™éœ€è¦å…ˆæ³¨å†Œæ‰èƒ½ä¸‹è½½ã€‚

![](2.png)

### é¦–æ¬¡å¯åŠ¨

å®‰è£…å®Œæˆåï¼Œé¦–æ¬¡è¿è¡Œ UaExpert ä¼šæç¤ºåˆ›å»ºä¸€ä¸ªåº”ç”¨ç¨‹åºè¯ä¹¦ï¼Œå¡«å†™ä¸€äº›ç›¸å…³ä¿¡æ¯å³å¯ã€‚

![](3.png)

å¯åŠ¨åçš„ç•Œé¢å¦‚ä¸‹ã€‚

![](4.png)

### æ·»åŠ  OPC UA æœåŠ¡å™¨

ä¾æ¬¡å•å‡»èœå•æ  `Server` - `Add`ï¼Œæˆ–è€…ç›´æ¥å•å‡»å·¥å…·æ çš„ `â•` å›¾æ ‡ï¼Œä¼šå¼¹å‡ºæ·»åŠ æœåŠ¡å™¨å¯¹è¯æ¡†ã€‚åŒå‡» `Custom Discovery` ä¸‹é¢çš„æ–‡å­—ï¼Œè¾“å…¥ OPC UA æœåŠ¡å™¨çš„åœ°å€å’Œç«¯å£å·ã€‚

![](5.png)

å®Œæˆåä¼šçœ‹åˆ°æ–°æ·»åŠ çš„ OPC UA æœåŠ¡å™¨ä¿¡æ¯ï¼Œé€‰ä¸­å¼€é”çŠ¶ `ğŸ”“` å›¾æ ‡ï¼Œå¹¶å•å‡» `OK` æŒ‰é’®ï¼Œå³å®ŒæˆæœåŠ¡å™¨æ·»åŠ çš„æ“ä½œã€‚

![](6.png)

### è¿æ¥ OPC UA æœåŠ¡å™¨

æœåŠ¡å™¨æ·»åŠ å®Œæˆåï¼Œåœ¨å·¦ä¾§é¡¹ç›®æ ‘çš„ `Servers` ä¼šæ˜¾ç¤ºç›¸å…³ä¿¡æ¯ï¼Œæ­¤æ—¶æœåŠ¡å™¨å°šæœªè¿æ¥ã€‚å•å‡»å·¥å…·æ çš„æ’å¤´ `ğŸ”Œ` å›¾æ ‡ï¼Œæˆ–è€…å³å‡»æœåŠ¡å™¨ç‚¹å‡» `Connect`ï¼Œå³å¯è¿æ¥æœåŠ¡å™¨ã€‚

![](7.png)

### æŸ¥çœ‹ PLC æ•°æ®

æˆåŠŸè¿æ¥åï¼Œä¼šåœ¨ç•Œé¢å·¦ä¸‹ä¾§ `Address Space` æ˜¾ç¤º PLC ä¸­çš„ç›¸å…³æ•°æ®ã€‚æ‰¾åˆ°æƒ³è¦ç›‘æ§ï¼ˆè®¢é˜…ï¼‰çš„æ•°æ®ï¼Œå°†å…¶ç›´æ¥æ‹–æ”¾åˆ°ç•Œé¢ä¸­é—´çš„ `Data Access View` å°±å¯ä»¥å®æ—¶è§‚å¯Ÿæ•°æ®çš„å˜åŒ–ã€‚ç•Œé¢å³ä¾§ `Attributes` å¯ä»¥æ˜¾ç¤ºé€‰ä¸­èŠ‚ç‚¹çš„ç›¸å…³å±æ€§ã€‚

![](8.png)

## ä½¿ç”¨ C# è¯»å†™ OPC UA æ•°æ®

é¦–å…ˆéœ€è¦åœ¨é¡¹ç›®ä¸­å¼•ç”¨ NuGet åŒ… `OPCFoundation.NetStandard.Opc.Ua`ã€‚

### è¿æ¥åˆ° OPC UA æœåŠ¡å™¨

1. åˆ›å»ºä¸€ä¸ªåº”ç”¨é…ç½®å¯¹è±¡ï¼Œç”¨äºè®¾ç½®åº”ç”¨åç§°ã€å”¯ä¸€æ ‡è¯†ã€ç±»å‹ã€è¯ä¹¦å’Œå®‰å…¨ç­–ç•¥ï¼›
    ```csharp
    // åˆ›å»ºä¸€ä¸ªåº”ç”¨é…ç½®å¯¹è±¡ï¼Œç”¨äºè®¾ç½®åº”ç”¨åç§°ã€å”¯ä¸€æ ‡è¯†ã€ç±»å‹ã€è¯ä¹¦å’Œå®‰å…¨ç­–ç•¥
    var config = new ApplicationConfiguration()
    {
        ApplicationName = "MyClient",
        ApplicationUri = Utils.Format(@"urn:{0}:MyClient", System.Net.Dns.GetHostName()),
        ApplicationType = ApplicationType.Client,
        SecurityConfiguration = new SecurityConfiguration
        {
            ApplicationCertificate = new CertificateIdentifier { StoreType = @"Directory", StorePath = @"%CommonApplicationData%\OPC Foundation\CertificateStores\MachineDefault", SubjectName = "MyClientSubjectName" },
            TrustedIssuerCertificates = new CertificateTrustList { StoreType = @"Directory", StorePath = @"%CommonApplicationData%\OPC Foundation\CertificateStores\UA Certificate Authorities" },
            TrustedPeerCertificates = new CertificateTrustList { StoreType = @"Directory", StorePath = @"%CommonApplicationData%\OPC Foundation\CertificateStores\UA Applications" },
            RejectedCertificateStore = new CertificateTrustList { StoreType = @"Directory", StorePath = @"%CommonApplicationData%\OPC Foundation\CertificateStores\RejectedCertificates" },
            AutoAcceptUntrustedCertificates = true,
            RejectSHA1SignedCertificates = false,
            MinimumCertificateKeySize = 1024,
            NonceLength = 32,
        },
        TransportConfigurations = new TransportConfigurationCollection(),
        TransportQuotas = new TransportQuotas { OperationTimeout = 15000 },
        ClientConfiguration = new ClientConfiguration { DefaultSessionTimeout = 60000 },
        TraceConfiguration = new TraceConfiguration()
    };

    // éªŒè¯åº”ç”¨é…ç½®å¯¹è±¡
    await config.Validate(ApplicationType.Client);

    // è®¾ç½®è¯ä¹¦éªŒè¯äº‹ä»¶ï¼Œç”¨äºè‡ªåŠ¨æ¥å—ä¸å—ä¿¡ä»»çš„è¯ä¹¦
    if (config.SecurityConfiguration.AutoAcceptUntrustedCertificates)
    {
        config.CertificateValidator.CertificateValidation += (s, e) => { e.Accept = (e.Error.StatusCode == StatusCodes.BadCertificateUntrusted); };
    }
    ```
2. æ£€æŸ¥åº”ç”¨å®ä¾‹å¯¹è±¡çš„è¯ä¹¦;
    ```csharp
    // åˆ›å»ºä¸€ä¸ªåº”ç”¨å®ä¾‹å¯¹è±¡ï¼Œç”¨äºæ£€æŸ¥è¯ä¹¦
    var application = new ApplicationInstance(config);

    // æ£€æŸ¥åº”ç”¨å®ä¾‹å¯¹è±¡çš„è¯ä¹¦
    bool check = await application.CheckApplicationInstanceCertificate(false, 2048);
    ```
3. åˆ›å»ºä¸€ä¸ªä¼šè¯å¯¹è±¡ï¼Œç”¨äºè¿æ¥åˆ° OPC UA æœåŠ¡å™¨ï¼›
    ```csharp
    // åˆ›å»ºä¸€ä¸ªä¼šè¯å¯¹è±¡ï¼Œç”¨äºè¿æ¥åˆ° OPC UA æœåŠ¡å™¨
    EndpointDescription endpointDescription = CoreClientUtils.SelectEndpoint("opc.tcp://192.168.0.100:4840", true);
    EndpointConfiguration endpointConfiguration = EndpointConfiguration.Create(config);
    ConfiguredEndpoint endpoint = new ConfiguredEndpoint(null, endpointDescription, endpointConfiguration);
    Session session = await Session.Create(config, endpoint, false, false, "DataCollector", 60000, new UserIdentity(), null);
    ```

### è·å–èŠ‚ç‚¹çš„å€¼

1. å•æ¬¡è¯»å–èŠ‚ç‚¹çš„å€¼
    ```csharp
    DataValue value = session.ReadValue(nodeId: "ns=6;s=::MyNode");
    Console.WriteLine("{0}, {1}, {2}", value.Value, value.SourceTimestamp, value.StatusCode);
    ```
2. è®¢é˜…è¯»å–èŠ‚ç‚¹çš„å€¼
    ```csharp
    // åˆ›å»ºä¸€ä¸ªè®¢é˜…å¯¹è±¡ï¼Œç”¨äºè®¢é˜…èŠ‚ç‚¹çš„å€¼
    var subscription = new Subscription(session.DefaultSubscription) { PublishingInterval = 1000 };
    session.AddSubscription(subscription);
    subscription.Create();

    // åˆ›å»ºä¸€ä¸ªç›‘è§†é¡¹å¯¹è±¡ï¼Œç”¨äºæŒ‡å®šè¦è®¢é˜…çš„èŠ‚ç‚¹
    MonitoredItem monitoredItem = new MonitoredItem()
    {
        DisplayName = "MyNode",
        StartNodeId = "ns=6;s=::MyNode"
    };

    // æ·»åŠ ä¸€ä¸ªé€šçŸ¥äº‹ä»¶ï¼Œç”¨äºå¤„ç†èŠ‚ç‚¹å€¼çš„å˜åŒ–
    monitoredItem.Notification += (item, e) =>
    {
        foreach (var value in item.DequeueValues())
        {
            Console.WriteLine("{0}: {1}, {2}, {3}", item.DisplayName, value.Value, value.SourceTimestamp, value.StatusCode);
        }
    };

    // å°†ç›‘è§†é¡¹å¯¹è±¡æ·»åŠ åˆ°è®¢é˜…å¯¹è±¡ä¸­
    subscription.AddItem(monitoredItem);

    // åº”ç”¨è®¢é˜…çš„å˜åŒ–
    subscription.ApplyChanges();
    ```

![](10.png)

### å†™å…¥èŠ‚ç‚¹çš„å€¼

```csharp
// å†™å…¥æ•°æ®åˆ°èŠ‚ç‚¹
WriteValue value = new WriteValue()
{
    NodeId = "ns=6;s=::MyNode",
    Value = new DataValue(new Variant(123))
};

ResponseHeader response = session.Write(null, new WriteValueCollection { value }, out StatusCodeCollection statuses, out DiagnosticInfoCollection diagnostics);
```
