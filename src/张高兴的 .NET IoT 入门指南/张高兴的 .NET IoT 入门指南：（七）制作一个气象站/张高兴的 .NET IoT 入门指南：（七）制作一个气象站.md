è·ç¦»ä¸Šä¸€ç¯‡ã€Šå¼ é«˜å…´çš„ .NET Core IoT å…¥é—¨æŒ‡å—ã€‹ç³»åˆ—åšå®¢çš„å‘å¸ƒå·²ç»è¿‡å» 2 å¹´çš„æ—¶é—´äº†ï¼Œ2 å¹´çš„æ—¶é—´ .NET ç‰ˆæœ¬å‘ç”Ÿäº†å·¨å¤§çš„å˜åŒ–ï¼Œ.NET Core ä¹Ÿå·²ä¸å¤å­˜åœ¨ï¼Œå› æ­¤æœ¬ç³»åˆ—åšå®¢æ›´åä¸º ã€Šå¼ é«˜å…´çš„ .NET IoT å…¥é—¨æŒ‡å—ã€‹ï¼Œæˆ‘ä¹Ÿé‡æ–°å®¡é˜…äº†ä¹‹å‰çš„å†…å®¹è¿›è¡Œäº†ç›¸åº”çš„æ›´æ”¹ä»¥ä¿è¯å†…å®¹çš„æ—¶æ•ˆæ€§ã€‚

å’Œå•ç‰‡æœºä¸åŒï¼Œä½¿ç”¨ Linux å¼€å‘æ¿ã€ç°æˆçš„ä¼ æ„Ÿå™¨å¥—ä»¶ä»¥åŠåˆé€‚çš„åç«¯æŠ€æœ¯å‡ ä¹å¯ä»¥åšæˆä»»ä½•ä¸œè¥¿ã€‚ä¸ºäº†æ›´å¥½çš„æ•´åˆå‰é¢ç« èŠ‚ä»‹ç»çš„å†…å®¹ï¼Œæœ¬æ–‡å°†åˆ¶ä½œä¸€ä¸ªç®€å•çš„æ°”è±¡ç«™ï¼ˆä¹Ÿè®¸å«ç¯å¢ƒä¿¡æ¯æ”¶é›†è£…ç½®æ›´åˆé€‚ï¼‰ï¼Œè‡³äºä¸ºä½•é€‰æ‹©åˆ¶ä½œä¸€ä¸ªæ°”è±¡ç«™ï¼Œå› ä¸ºéš¾åº¦ä¸é«˜åˆ¶ä½œä¸å¤æ‚ï¼Œå¹¶ä¸”æ¸©æ¹¿åº¦ä¼ æ„Ÿå™¨èŠ±è´¹è¾ƒä½çš„ä»·æ ¼å³å¯è·å¾—ï¼Œå¯ä»¥ä»¥ä½å»‰çš„ä»·æ ¼æ¢å–ä¸€ä¸ª cool stuffã€‚æœ¬æ–‡å°†ä½¿ç”¨ .NET 6 ç¼–å†™ä¸€ä¸ªæ§åˆ¶å°åº”ç”¨ç¨‹åºï¼Œé€šè¿‡æœ¬æ–‡ä½ å¯ä»¥å­¦åˆ°ï¼š
1. I2C `I2cDevice` ç±»çš„ä½¿ç”¨ï¼›
2. æ‘„åƒå¤´è®¾å¤‡ `VideoDevice` ç±»çš„ä½¿ç”¨ï¼›
3. `Iot.Device.Bindings` NuGet åŒ…çš„ä½¿ç”¨ï¼›
4. æ—¶åºæ•°æ®åº“ `TimescaleDB` çš„ç®€å•ä½¿ç”¨ï¼›
5. `Quartz` å®šæ—¶ä»»åŠ¡çš„ä½¿ç”¨ï¼›
6. åœ¨æ§åˆ¶å°åº”ç”¨ä¸­è¿›è¡Œä¾èµ–æ³¨å…¥ï¼›
7. ä½¿ç”¨ `Docker` æ‹‰å–é•œåƒã€éƒ¨ç½²åº”ç”¨ã€‚

* [ç¡¬ä»¶éœ€æ±‚]()
* [ç”µè·¯]()
* [å‡†å¤‡å·¥ä½œ]()
  * [é…ç½® TimescaleDB æ•°æ®åº“]()
  * [å®‰è£…æ‘„åƒå¤´çš„ä¾èµ–åº“]()
* [ç¼–å†™ä»£ç ]()
  * [é¡¹ç›®ç»“æ„]()
  * [é¡¹ç›®ä¾èµ–]()
  * [æ•°æ®åº“ä¸Šä¸‹æ–‡ä¸å®ä½“ç±»]()
  * [é…ç½®æ–‡ä»¶]()
  * [åˆå§‹åŒ–ä¸ä¾èµ–æ³¨å…¥é…ç½®]()
  * [é…ç½®å®šæ—¶ä»»åŠ¡]()
* [éƒ¨ç½²åº”ç”¨]()
  * [å‘å¸ƒåˆ°æ–‡ä»¶]()
  * [æ„å»º Docker é•œåƒ]()
* [åç»­å·¥ä½œ]()

## ç¡¬ä»¶éœ€æ±‚

| åç§° | æè¿° | æ•°é‡ |
| :-: | :-: | :-: |
| Orange Pi Zero | Linux å¼€å‘æ¿ | x1 |
| BME280 | æä¾›æ¸©åº¦ã€æ¹¿åº¦ä»¥åŠæ°”å‹æ•°æ® | x1 |
| USB æ‘„åƒå¤´ | æä¾›ç¯å¢ƒå›¾åƒ | x1 |
| æœé‚¦çº¿ | ä¼ æ„Ÿå™¨ä¸å¼€å‘æ¿çš„è¿æ¥çº¿ | è‹¥å¹² |

## ç”µè·¯

![](1.jpg)

| ä¼ æ„Ÿå™¨ | æ¥å£ | å¼€å‘æ¿æ¥å£ |
| :-: | :-: | :-: |
| BME280 | SDA | TWI0_SDA (Pin 3) |
| | SCL | TWI0_SCK (Pin 5) |
| | VCC | 5V (Pin 4) |
| | GND | GND (Pin 6) |
| USB æ‘„åƒå¤´ | USB | USB |

## å‡†å¤‡å·¥ä½œ

### é…ç½® TimescaleDB æ•°æ®åº“

TimescaleDB æ˜¯ä¸€æ¬¾åŸºäº PostgreSQL æ’ä»¶çš„æ—¶åºæ•°æ®åº“ã€‚è€ƒè™‘åˆ°æ”¶é›†çš„ç¯å¢ƒæ•°æ®æ˜¯æŒ‰æ—¶é—´è¿›è¡Œç´¢å¼•ï¼Œå¹¶ä¸”æ•°æ®åŸºæœ¬ä¸Šéƒ½æ˜¯æ’å…¥ï¼Œæ²¡æœ‰æ›´æ–°çš„éœ€æ±‚ï¼Œå› æ­¤é€‰ç”¨äº†æ—¶åºæ•°æ®åº“ä½œä¸ºæ•°æ®å­˜å‚¨ã€‚TimescaleDB æ˜¯ PostgreSQL çš„ä¸€æ¬¾æ’ä»¶ï¼Œå¯ä»¥é€šè¿‡å…ˆå®‰è£… PostgreSQL ä¹‹åå†å®‰è£…æ’ä»¶çš„å½¢å¼éƒ¨ç½² TimescaleDBï¼Œè¿™é‡Œç›´æ¥ä½¿ç”¨ TimescaleDB çš„ Docker é•œåƒè¿›è¡Œéƒ¨ç½²ã€‚

1. æ‹‰å– TimescaleDB é•œåƒï¼š
```
docker pull timescale/timescaledb:latest-pg14
```
2. åˆ›å»ºå·ï¼Œç”¨äºæŒä¹…åŒ–æ•°æ®åº“æ•°æ®ï¼š
```
docker volume create tsdb_data
```
3. è¿è¡Œé•œåƒï¼Œç«¯å£æ˜ å°„ä¸º `54321`ï¼Œå¯†ç é…ç½®ä¸ºå¼±å¯†ç  `@Passw0rd`ï¼š
```
docker run -d --name timescaledb -p 54321:5432 --restart=always -e POSTGRES_PASSWORD='@Passw0rd' -e TZ='Asia/Shanghai' -e ALLOW_IP_RANGE=0.0.0.0/0 -v tsdb_data:/var/lib/postgresql timescale/timescaledb:latest-pg14
```
4. ä½¿ç”¨ç†Ÿæ‚‰çš„æ•°æ®åº“ç®¡ç†å·¥å…·ï¼ˆå¦‚ Navicatï¼‰åˆ›å»ºæ•°æ®åº“ `WeatherMetrics`ï¼š
```sql
CREATE DATABASE "WeatherMetrics"
WITH OWNER = postgres ENCODING = 'UTF8';

CREATE TABLE metrics (
   time TIMESTAMP WITHOUT TIME ZONE NOT NULL DEFAULT 'now()',
   device_id VARCHAR(50) NULL,
   weather_type VARCHAR(50) NULL,
   temperature DECIMAL(5, 2) NULL,
   humidity DECIMAL(5, 2) NULL,
   pressure DECIMAL(8, 2) NULL,
   image_base64 TEXT NULL
);

SELECT create_hypertable('metrics', 'time');
```

`time` è¡¨ç¤ºé‡‡é›†æ•°æ®çš„æ—¶é—´ï¼Œ`device_id` è®°å½•é‡‡é›†è®¾å¤‡çš„ idï¼Œ`weather_type` è®°å½•ä»å¿ƒçŸ¥å¤©æ°”è·å–çš„å¤©æ°”åï¼Œ`temperature` è®°å½•ä¼ æ„Ÿå™¨è·å–çš„æ¸©åº¦ï¼Œ`humidity` è®°å½•ä¼ æ„Ÿå™¨è·å–çš„æ¹¿åº¦ï¼Œ`pressure` è®°å½•ä¼ æ„Ÿå™¨è·å–çš„æ°”å‹ï¼Œ`image_base64` è®°å½•æ‘„åƒå¤´é‡‡é›†çš„å›¾åƒã€‚

<div style="display: block;position: relative;border-radius: 8px;padding: 1rem;background-color: #d2f9d2;color: #094409;margin: 10px">
    <p style="margin-top:0;font-weight: bold">ğŸ’¡&nbsp;æç¤º</p>
    <p><span>åœ¨æ•°æ®åº“ä¸­å­˜å‚¨ä»»ä½•å­—ç¬¦ç±»å‹ä»¥å¤–çš„æ•°æ®éƒ½æ˜¯æ„šè ¢çš„ï¼Œè¿™é‡Œæ˜¯ä¸ºäº†æ¼”ç¤ºï¼Œå¹¶ä¸”åªæ˜¯ä½åˆ†è¾¨ç‡çš„å›¾åƒã€‚</span></p>
</div>

è¶…è¡¨ï¼ˆhypertableï¼‰æ˜¯ TimescaleDB çš„ä¸€ä¸ªé‡è¦æ¦‚å¿µï¼Œç”±è‹¥å¹²ä¸ªå—ï¼ˆchunksï¼‰ç»„æˆï¼Œå°†è¶…è¡¨ä¸­çš„æ•°æ®æŒ‰ç…§æ—¶é—´åˆ—ï¼ˆå³ `metrics` è¡¨ä¸­çš„ `time` å­—æ®µï¼‰åˆ†æˆè‹¥å¹²ä¸ªå—å­˜å‚¨ï¼Œè€Œä½¿ç”¨ PostgreSQL å±‚é¢ä¸Šçš„è¡¨ï¼ˆtableï¼‰å®ç° SQL æ¥å£çš„æš´éœ²ï¼Œå› æ­¤ä½¿ç”¨ `create_hypertable()` å°†è¡¨è½¬æ¢ä¸ºè¶…è¡¨ã€‚ä¸Šé¢åˆ›å»ºçš„ `metrics` è¡¨å¹¶ä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„è¡¨ï¼Œè¡¨ä¸­ä¸å­˜åœ¨ä¸»é”®å­—æ®µï¼Œè€Œæ˜¯ç±»ä¼¼è§†å›¾ï¼ˆviewï¼‰ä¸€æ ·çš„æŠ½è±¡ç»“æ„ã€‚

### å®‰è£…æ‘„åƒå¤´çš„ä¾èµ–åº“

[VideoDevice](https://github.com/ZhangGaoxing/v4l2.net) ç±»æ˜¯ä½¿ç”¨ PInvoke æ“ä½œå®ç°çš„ï¼Œä¾èµ–äº Video for Linux 2ï¼ˆV4L2ï¼‰ï¼Œå› æ­¤è¿˜éœ€è¦å®‰è£… V4L2 å·¥å…·ï¼š
```
sudo apt install v4l-utils
```
å®ç°æ—¶è¿˜å¼•ç”¨äº† `System.Drawing` NuGet åŒ…ï¼Œå› æ­¤è¿˜éœ€è¦å®‰è£… `System.Drawing` çš„å‰ç½®ä¾èµ–ï¼š
```
sudo apt install libc6-dev libgdiplus libx11-dev
```

## ç¼–å†™ä»£ç 

é¡¹ç›®åœ°å€ï¼šhttps://github.com/ZhangGaoxing/weather-metrics

### é¡¹ç›®ç»“æ„

åˆ›å»ºä¸€ä¸ªæ§åˆ¶å°åº”ç”¨å’Œç±»åº“ï¼Œé¡¹ç›®ç»“æ„å¦‚ä¸‹ï¼š

![](2.jpg)

### é¡¹ç›®ä¾èµ–

`WeatherMetrics.ConsoleApp` æ·»åŠ å¦‚ä¸‹ NuGet åŒ…å¼•ç”¨ï¼š

```xml
<ItemGroup>
   <PackageReference Include="Iot.Device.Bindings" Version="2.0.0" />
   <PackageReference Include="Microsoft.Extensions.Configuration.Json" Version="6.0.0" />
   <PackageReference Include="Microsoft.Extensions.DependencyInjection" Version="6.0.0" />
   <PackageReference Include="Newtonsoft.Json" Version="13.0.1" />
   <PackageReference Include="Quartz" Version="3.3.3" />
   <PackageReference Include="System.Device.Gpio" Version="2.0.0" />
</ItemGroup>
```

`WeatherMetrics.Models` æ·»åŠ å¦‚ä¸‹ NuGet åŒ…å¼•ç”¨ï¼š

```xml
<ItemGroup>
   <PackageReference Include="Npgsql.EntityFrameworkCore.PostgreSQL" Version="6.0.3" />
</ItemGroup>
```

### æ•°æ®åº“ä¸Šä¸‹æ–‡ä¸å®ä½“ç±»

TimescaleDB æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ª PostgreSQL æ•°æ®åº“ï¼Œå› æ­¤æ•°æ®åº“è®¿é—®ä½¿ç”¨ Npgsql é©±åŠ¨ã€‚é¦–å…ˆæ·»åŠ å®ä½“ç±» `Metrics.cs`ï¼š
```csharp
public class Metrics
{
    [Column("time")]
    public DateTime Time { get; set; } = DateTime.Now;

    [Column("device_id")]
    public string DeviceId { get; set; }

    [Column("weather_type")]
    public string WeatherType { get; set; }

    [Column("temperature")]
    public double Temperature { get; set; }

    [Column("humidity")]
    public double Humidity { get; set; }

    [Column("pressure")]
    public double Pressure { get; set; }

    [Column("image_base64")]
    public string ImageBase64 { get; set; }
}
```

æ¥ç€æ·»åŠ æ•°æ®åº“ä¸Šä¸‹æ–‡ `WeatherContext.cs`ï¼š
```csharp
public class WeatherContext : DbContext
{
    private readonly string _connectString;

    public WeatherContext(string connectString)
    {
        _connectString = connectString;
    }

    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
    {
        AppContext.SetSwitch("Npgsql.EnableLegacyTimestampBehavior", true);
        optionsBuilder.UseNpgsql(_connectString);
    }

    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        modelBuilder.Entity<Metrics>()
            .ToTable("metrics")
            .HasNoKey();
    }
}
```

è¿™é‡Œä½¿ç”¨äº†ä¸€ä¸ªä¼ é€’æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²çš„æ„é€ å‡½æ•°ï¼Œè¿æ¥å­—ç¬¦ä¸²ä» `appsettings.json` æ–‡ä»¶ä¸­è¯»å–ã€‚ç”±äº `metrics` è¡¨æ˜¯æ— ä¸»é”®çš„ï¼Œè¿˜éœ€è¦ä½¿ç”¨ `HasNoKey()` è¿›è¡Œæ ‡è®°ã€‚EF Core ç”±äºä½¿ç”¨äº†å®ä½“è·Ÿè¸ªï¼Œå› æ­¤æ— æ³•å¯¹æ— ä¸»é”®çš„è¡¨è¿›è¡Œä¿®æ”¹ï¼Œåªèƒ½é€šè¿‡æ‰§è¡Œ SQL çš„æ–¹å¼æ’å…¥æ•°æ®ï¼Œåœ¨ `Metrics.cs` ä¸­æ–°å¢æ–¹æ³•ï¼š
```csharp
public static bool Insert(DbContext context, Metrics metrics)
{
   int row = context.Database.ExecuteSqlRaw("INSERT INTO metrics VALUES ({0}, {1}, {2}, {3}, {4}, {5}, {6})", metrics.Time, metrics.DeviceId, metrics.WeatherType, metrics.Temperature, metrics.Humidity, metrics.Pressure, metrics.ImageBase64);

   return row > 0;
}
```

<div style="display: block;position: relative;border-radius: 8px;padding: 1rem;background-color: #ffdacc;color: #651b01;margin: 10px">
    <p style="margin-top:0;font-weight: bold">âš ï¸&nbsp;è­¦å‘Š</p>
    <p><span>è¯·ä¸è¦åœ¨ SQL ä¸­ä½¿ç”¨å­—ç¬¦ä¸²å†…æ’ã€‚</span></p>
</div>

### é…ç½®æ–‡ä»¶

åœ¨ `appsettings.json` ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š
```json
{
  // æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸² 
  "ConnectionString": "Server=localhost;Port=54321;Database=WeatherMetrics;User Id=postgres;Password=@Passw0rd;",
  // å®šæ—¶ä»»åŠ¡è®¾ç½®
  "QuartzCron": "0 0/1 * * * ? *",
  // å¿ƒçŸ¥å¤©æ°”çš„é…ç½®
  "Xinzhi": {
    "Key": "",
    "Location": "34.24:117.16"
  }
}
```

### åˆå§‹åŒ–ä¸ä¾èµ–æ³¨å…¥é…ç½®

æ–°å»ºä¸€ä¸ªé™æ€ç±» `AppConfig`ï¼Œç”¨äºä¿å­˜ä¾èµ–æ³¨å…¥çš„ `ServiceProvider` å˜é‡ï¼š
```csharp
public static class AppConfig
{
    public static IServiceProvider ServiceProvider { get; set; }
}
```

åœ¨ `Program.cs` ä¸­æ·»åŠ åˆå§‹åŒ–ä»£ç ï¼š
```csharp
// è¯»å–é…ç½®æ–‡ä»¶
var config = new ConfigurationBuilder()
    .AddJsonFile("appsettings.json")
    .Build();

// å®ä¾‹åŒ–æ•°æ®åº“ä¸Šä¸‹æ–‡
using WeatherContext context = new WeatherContext(config["ConnectionString"]);

// é…ç½® I2Cï¼Œå®ä¾‹åŒ–ä¼ æ„Ÿå™¨
I2cConnectionSettings i2cSettings = new I2cConnectionSettings(busId: 0, deviceAddress: Bmx280Base.SecondaryI2cAddress);
using I2cDevice i2c = I2cDevice.Create(i2cSettings);
using Bme280 bme = new Bme280(i2c);

// å®ä¾‹åŒ–æ‘„åƒå¤´
VideoConnectionSettings videoSettings = new VideoConnectionSettings(busId: 0, captureSize: (640, 480));
using VideoDevice video = VideoDevice.Create(videoSettings);

// é…ç½®ä¾èµ–æ³¨å…¥
AppConfig.ServiceProvider = new ServiceCollection()
    .AddSingleton(config)
    .AddSingleton(context)
    .AddSingleton(bme)
    .AddSingleton(video)
    .BuildServiceProvider();
```

### é…ç½®å®šæ—¶ä»»åŠ¡

å®šæ—¶ä»»åŠ¡é€šè¿‡ `appsettings.json` ä¸­çš„ `QuartzCron` å­—æ®µè®¾ç½®ã€‚Cron è¡¨è¾¾å¼åˆ†ä¸º 7 ä¸ªéƒ¨åˆ†ï¼Œä»å·¦è‡³å³åˆ†åˆ«ä»£è¡¨ï¼šSecondsã€Minutesã€Hoursã€DayofMonthã€Monthã€DayofWeek ä»¥åŠ Yearã€‚`*` å‡ºç°çš„éƒ¨åˆ†è¡¨ç¤ºä»»æ„å€¼éƒ½ä¼šè§¦å‘å®šæ—¶ä»»åŠ¡ï¼Œ`/` å·¦ä¾§è¡¨ç¤ºè§¦å‘çš„èµ·å§‹æ—¶é—´ï¼Œå³ä¾§è¡¨ç¤ºè§¦å‘é—´éš”ï¼Œä»¥ `appsettings.json` ä¸­çš„ä¸ºä¾‹ï¼Œè¡¨ç¤ºä»æ¯å°æ—¶çš„ç¬¬ 0 åˆ†å¼€å§‹è§¦å‘ï¼Œæ¯ä¸€åˆ†é’Ÿè§¦å‘ä¸€æ¬¡ã€‚

æ–°å»º `MetricsJob` ç±»ï¼Œç”¨äºå®ç°å®šæ—¶ä»»åŠ¡ï¼š
```csharp
public class MetricsJob : IJob
{
    public Task Execute(IJobExecutionContext context)
    {
        return Task.Run(async () =>
        {
            // TODOï¼šåœ¨æ­¤å¤„å®ç°å®šæ—¶ä»»åŠ¡
            // éœ€è¦å®Œæˆä¼ æ„Ÿå™¨çš„è¯»å–ï¼Œå¿ƒçŸ¥å¤©æ°”çš„è¯·æ±‚ï¼Œæ•°æ®åº“çš„æ’å…¥
        });
    }
}
```

#### ä¼ æ„Ÿå™¨çš„è¯»å–

åœ¨ `MetricsJob` ç±»ä¸­æ·»åŠ æ–¹æ³•ï¼š
```csharp
private Metrics GetMetrics()
{
    // è·å–ä¾èµ–æ³¨å…¥çš„ Bme280 å¯¹è±¡
    Bme280 bme = (Bme280)AppConfig.ServiceProvider.GetService(typeof(Bme280));

    // è®¾ç½®ä¼ æ„Ÿå™¨çš„ç”µæºæ¨¡å¼
    bme.SetPowerMode(Bmx280PowerMode.Normal);

    // è®¾ç½®è¯»å–ç²¾åº¦
    bme.PressureSampling = Sampling.UltraHighResolution;
    bme.TemperatureSampling = Sampling.UltraHighResolution;
    bme.HumiditySampling = Sampling.UltraHighResolution;

    // è¯»å–æ•°æ®
    bme.TryReadPressure(out UnitsNet.Pressure p);
    bme.TryReadTemperature(out UnitsNet.Temperature t);
    bme.TryReadHumidity(out UnitsNet.RelativeHumidity h);

    // ä¼ æ„Ÿå™¨ä¼‘çœ 
    bme.SetPowerMode(Bmx280PowerMode.Sleep);

    return new Metrics
    {
        DeviceId = Dns.GetHostName(),
        Temperature = Math.Round(t.DegreesCelsius, 2),
        Humidity = Math.Round(h.Percent, 2),
        Pressure = Math.Round(p.Pascals, 2)
    };
}
```

#### æ‘„åƒå¤´æ•è·å›¾åƒ

åœ¨ `MetricsJob` ç±»ä¸­æ·»åŠ æ–¹æ³•ï¼š
```csharp
private string GetImage()
{
    VideoDevice video = (VideoDevice)AppConfig.ServiceProvider.GetService(typeof(VideoDevice));

    byte[] image = video.Capture();
    return Convert.ToBase64String(image);
}
```

#### å¿ƒçŸ¥å¤©æ°” API è¯·æ±‚

é€šè¿‡è¯·æ±‚å¿ƒçŸ¥å¤©æ°” API è·å¾—å½“å‰ä½ç½®çš„å¤©æ°”åç§°ï¼Œéœ€è¦æå‰åœ¨ https://www.seniverse.com/api ç”³è¯· API Keyã€‚åœ¨ `MetricsJob` ç±»ä¸­æ·»åŠ æ–¹æ³•ï¼š
```csharp
private async Task<string> GetXinzhiWeatherAsync()
{
    IConfigurationRoot config = (IConfigurationRoot)AppConfig.ServiceProvider.GetService(typeof(IConfigurationRoot));

    using HttpClient client = new HttpClient();

    try
    {
        var json = await client.GetStringAsync($"https://api.seniverse.com/v3/weather/now.json?key={config["Xinzhi:Key"]}&location={config["Xinzhi:Location"]}&language=zh-Hans&unit=c");
        return (string)JsonConvert.DeserializeObject<dynamic>(json).results[0].now.text;
    }
    catch (Exception)
    {
        return string.Empty;
    }
}
```

#### å®Œå–„å®šæ—¶ä»»åŠ¡

```csharp
public Task Execute(IJobExecutionContext context)
{
    return Task.Run(async () =>
    {
        var metrics = GetMetrics();
        metrics.WeatherType = await GetXinzhiWeatherAsync();
        metrics.ImageBase64 = GetImage();

        WeatherContext context = (WeatherContext)AppConfig.ServiceProvider.GetService(typeof(WeatherContext));

        Metrics.Insert(context, metrics);
    });
}
```

#### åˆ›å»ºå®šæ—¶ä»»åŠ¡è§¦å‘å™¨

åœ¨ `Program.cs` ä¸­æ·»åŠ ï¼š
```csharp
// åˆ›å»ºä¸€ä¸ªè§¦å‘å™¨
var trigger = TriggerBuilder.Create()
    .WithCronSchedule(config["QuartzCron"])
    .Build();

// åˆ›å»ºä»»åŠ¡
var jobDetail = JobBuilder.Create<MetricsJob>()
    .WithIdentity("job", "group")
    .Build();

// ç»‘å®šè°ƒåº¦å™¨
ISchedulerFactory factory = new StdSchedulerFactory();
var scheduler = await factory.GetScheduler();
await scheduler.ScheduleJob(jobDetail, trigger);
await scheduler.Start();
```

è¿™æ ·ä¸€ä¸ªä¸€åˆ†é’Ÿé‡‡é›†ä¸€æ¬¡æ•°æ®çš„ç®€æ˜“æ°”è±¡ç«™å°±å®Œæˆäº†ã€‚

## éƒ¨ç½²åº”ç”¨

### å‘å¸ƒåˆ°æ–‡ä»¶

1. åˆ‡æ¢åˆ° `WeatherMetrics.ConsoleApp` é¡¹ç›®è¿è¡Œå‘å¸ƒå‘½ä»¤ï¼š
```
dotnet publish -c release -r linux-arm
```
2. å°†å‘å¸ƒåçš„æ–‡ä»¶é€šè¿‡ FTP ç­‰æ–¹å¼å¤åˆ¶åˆ° Linux å¼€å‘æ¿ï¼›
3. ä¸º `WeatherMetrics.ConsoleApp` æ–‡ä»¶å¢åŠ å¯æ‰§è¡Œæƒé™
```
sudo chmod +x WeatherMetrics.ConsoleApp
```
4. è¿è¡Œç¨‹åº
```
sudo ./WeatherMetrics.ConsoleApp
```

### æ„å»º Docker é•œåƒ

1. æŸ¥çœ‹ TimescaleDB å®¹å™¨çš„ IPï¼Œå¹¶ä¿®æ”¹ `appsettings.json` çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼š
```
docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' timescaledb
```
2. åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸­åˆ›å»º `Dockerfile`ï¼Œå¹¶å°†æ•´ä¸ªé¡¹ç›®å¤åˆ¶åˆ° Linux å¼€å‘æ¿ä¸­ï¼š
```Dockerfile
FROM mcr.microsoft.com/dotnet/core/sdk:6.0-focal-arm32v7 AS build
WORKDIR /app

# publish app
COPY src .
WORKDIR /app/WeatherMetrics.ConsoleApp
RUN dotnet restore
RUN dotnet publish -c release -r linux-arm -o out

## run app
FROM mcr.microsoft.com/dotnet/core/runtime:6.0-focal-arm32v7 AS runtime
WORKDIR /app
COPY --from=build /app/WeatherMetrics.ConsoleApp/out ./

# install native dependencies
RUN apt update && \
    apt install -y --allow-unauthenticated v4l-utils libc6-dev libgdiplus libx11-dev

ENTRYPOINT ["dotnet", "WeatherMetrics.ConsoleApp.dll"]
```
3. åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•ï¼Œæ„å»ºé•œåƒï¼š
```
docker build -t weather-metrics -f Dockerfile .
```
4. è¿è¡Œé•œåƒï¼š
```
docker run --rm -it --device /dev/video0 --device /dev/i2c-0 weather-metrics
```

## åç»­å·¥ä½œ

ç¨‹åºè¿è¡Œä¸€æ®µæ—¶é—´åï¼Œä½¿ç”¨æ ‡å‡†çš„ SQL æŸ¥è¯¢ä¸€ä¸‹æ•°æ®ï¼š
```sql
SELECT * FROM metrics
ORDER BY time DESC
```

![](3.jpg)

ç¡¬ä»¶æ˜¯è½¯ä»¶çš„åŸºç¡€ï¼Œå¯¹æ”¶é›†åˆ°çš„æ•°æ®åç»­å¯ä»¥ä½¿ç”¨å…¶ä»–æŠ€æœ¯è¿›è¡Œå¤„ç†ï¼Œæ¯”å¦‚å¯ä»¥ä½¿ç”¨ ASP.NET ç¼–å†™ WEB åº”ç”¨å¯¹æ•°æ®è¿›è¡Œå±•ç¤ºï¼Œæˆ–è€…å¯ä»¥ä½¿ç”¨ ML.NET æ„å»ºæœºå™¨å­¦ä¹ æ¨¡å‹å¯¹å¤©æ°”è¿›è¡Œé¢„æµ‹ç­‰ç­‰ã€‚