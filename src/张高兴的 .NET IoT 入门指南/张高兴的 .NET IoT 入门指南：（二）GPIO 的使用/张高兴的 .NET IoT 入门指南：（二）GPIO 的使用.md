* [GPIO çš„ä½¿ç”¨]()
   * [ä»€ä¹ˆæ˜¯ GPIO]()
   * [ç›¸å…³ç±»]()
   * [äººä½“çº¢å¤–ä¼ æ„Ÿå™¨å®éªŒ]()

## ä»€ä¹ˆæ˜¯ GPIO

GPIO æ˜¯ General Purpose Input Output çš„ç¼©å†™ï¼Œå³â€œé€šç”¨è¾“å…¥è¾“å‡ºâ€ã€‚ Raspberry Pi æœ‰ä¸¤åˆ— GPIO å¼•è„šï¼Œ Raspberry Pi é€šè¿‡è¿™ä¸¤è¡Œå¼•è„šè¿›è¡Œä¸€äº›ç¡¬ä»¶ä¸Šçš„æ‰©å±•ï¼Œä¸ä¼ æ„Ÿå™¨è¿›è¡Œäº¤äº’ç­‰ç­‰ã€‚

![](1.png)
<p style="text-align:center;margin-bottom:25px;color:gray"><small>Raspberry Pi B+/2B/3B/3B+/Zero å¼•è„šå›¾</small></p>

ç®€å•çš„è®²ï¼Œæ¯ä¸€ä¸ª GPIO å¼•è„šéƒ½æœ‰ä¸¤ç§æ¨¡å¼ï¼šè¾“å‡ºæ¨¡å¼ï¼ˆOUTPUTï¼‰å’Œè¾“å…¥æ¨¡å¼ï¼ˆINPUTï¼‰ã€‚è¾“å‡ºæ¨¡å¼ç±»ä¼¼äºä¸€ä¸ªç”µæºï¼ŒRaspberry Pi å¯ä»¥æ§åˆ¶è¿™ä¸ªç”µæºæ˜¯å¦å‘å¤–ä¾›ç”µï¼Œæ¯”å¦‚æ‰“å¼€å¤–éƒ¨çš„ LED å°ç¯ï¼Œå½“ç„¶æœ€æœ‰ç”¨çš„è¿˜æ˜¯å‘å¤–éƒ¨è®¾å¤‡å‘é€ä¿¡å·ã€‚å’Œè¾“å‡ºæ¨¡å¼ç›¸åï¼Œè¾“å…¥æ¨¡å¼æ˜¯æ¥æ”¶å¤–éƒ¨è®¾å¤‡å‘æ¥çš„ä¿¡å·ã€‚å…¶ä¸­è¿˜åŒ…å«ä¸¤ç§ç‰¹æ®Šçš„è¾“å…¥æ¨¡å¼ï¼šä¸Šæ‹‰è¾“å…¥ï¼ˆINPUT_PULLUPï¼‰å’Œä¸‹æ‹‰è¾“å…¥ï¼ˆINPUT_PULLDOWNï¼‰ã€‚ä¸Šæ‹‰è¾“å…¥å°±æ˜¯å†…éƒ¨çš„ä¸Šæ‹‰ç”µé˜»æ¥ VCC ï¼Œå°†è¯¥å¼•è„šè®¾ç½®ä¸ºé«˜ç”µå¹³ï¼Œä¸‹æ‹‰è¾“å…¥åˆ™ç›¸åã€‚

GPIO é€šå¸¸é‡‡ç”¨æ ‡å‡†é€»è¾‘ç”µå¹³ï¼Œå³é«˜ç”µå¹³å’Œä½ç”µå¹³ï¼Œç”¨äºŒè¿›åˆ¶ 0 å’Œ 1 è¡¨ç¤ºã€‚åœ¨è¿™ä¸¤å€¼ä¸­é—´è¿˜æœ‰é˜ˆå€¼ç”µå¹³ï¼Œå³é«˜ç”µå¹³å’Œä½ç”µå¹³ä¹‹é—´çš„ç•Œé™ã€‚Arduino ä¼šå°† -0.5 ~ 1.5 V è¯»å–ä¸ºä½ç”µå¹³ï¼Œ3 ~ 5.5 V è¯»å–ä¸ºé«˜ç”µå¹³ï¼Œ Raspberry Pi æœªæŸ¥åˆ°ç›¸å…³èµ„æ–™ã€‚GPIO è¿˜å¯ç”¨äºä¸­æ–­è¯·æ±‚ï¼Œå³è®¾ç½® GPIO ä¸ºè¾“å…¥æ¨¡å¼ï¼Œå€¼è¾¾åˆ°ç›¸åº”çš„è¦æ±‚æ—¶è¿›è¡Œä¸­æ–­ã€‚

## ç›¸å…³ç±»

GPIO æ“ä½œä¸»è¦ä¾èµ–äº `GpioController` ç±»  ã€‚è¿™ä¸ªç±»ä½äº **System.Device.Gpio** åç§°ç©ºé—´ä¸‹ã€‚

### GpioController

```C#
// GpioController å³ GPIO æ§åˆ¶å™¨
// GPIO å¼•è„šä¾é  GpioController åˆå§‹åŒ–
public class GpioController : IGpioController, IDisposable
{
    // æ„é€ å‡½æ•°
    public GpioController();
    // PinNumberingScheme å³å¼•è„šç¼–å·æ–¹æ¡ˆï¼Œæ˜¯ä¸€ä¸ªæšä¸¾ç±»å‹ï¼ŒåŒ…å« Board å’Œ Logical ä¸¤ä¸ªå€¼ã€‚ 
    // å¯ä»¥çœ‹ä¸Šæ–¹çš„ Raspberry Pi å¼•è„šå›¾ï¼Œä»¥ GPIO 17 ä¸ºä¾‹ï¼Œå¦‚æœå®ä¾‹åŒ–æ—¶é€‰ Logical ï¼Œé‚£ä¹ˆæ‰“å¼€å¼•è„šæ—¶éœ€è¦å¡«å†™ 17ã€‚
    // å¦‚æœå®ä¾‹åŒ–æ—¶é€‰ Board ï¼Œé‚£ä¹ˆæ‰“å¼€å¼•è„šæ—¶éœ€è¦å¡«å†™å³ä¾§ç°è‰²æ–¹æ¡†å†…çš„å€¼ï¼Œå³ 11 ã€‚
    public GpioController(PinNumberingScheme numbering);
    // GpioDriver ç”¨äºæŒ‡å®šè¦ä½¿ç”¨çš„ GPIO é©±åŠ¨ï¼Œæ¯”å¦‚ libgpiod æˆ– sysfs
    public GpioController(PinNumberingScheme numberingScheme, GpioDriver driver);


    // æ–¹æ³•
    // æ‰“å¼€ GPIO å¼•è„š
    // pinNumber éœ€è¦å¡«å†™å’Œ PinNumberingScheme ç›¸å¯¹åº”çš„å€¼ã€‚
    // PinMode æ˜¯è®¾ç½® GPIO çš„æ¨¡å¼ï¼Œå¦‚è¾“å…¥ã€è¾“å‡ºã€ä¸Šæ‹‰ã€ä¸‹æ‹‰
    public void OpenPin(int pinNumber, PinMode mode);
    // å…³é—­ GPIO å¼•è„š
    public void ClosePin(int pinNumber);
    // åˆ¤æ–­æŸä¸ªå¼•è„šæ˜¯å¦æ‰“å¼€
    // æ³¨æ„ï¼šå¼•è„šè¿ç»­æ‰“å¼€ä¼šæŠ›å‡ºå¼‚å¸¸
    public bool IsPinOpen(int pinNumber); 

    // è¯»å–æŒ‡å®šå¼•è„šçš„å€¼
    public PinValue Read(int pinNumber);
    // å‘æŒ‡å®šçš„å¼•è„šå†™å…¥å€¼
    public void Write(int pinNumber, PinValue value);

    // ä¸ºæŒ‡å®šå¼•è„šçš„å€¼æ”¹å˜æ—¶æ³¨å†Œå›è°ƒï¼ˆå³ä¸Šæ–‡ä¸­æåˆ°çš„ GPIO ä¸­æ–­ï¼‰
    // PinEventTypes æ˜¯å€¼æ”¹å˜çš„ç±»å‹ï¼ŒåŒ…æ‹¬ä¸Šå‡æ²¿ï¼ˆRisingï¼Œ0->1ï¼‰å’Œä¸‹é™æ²¿ï¼ˆFallingï¼Œ1->0ï¼‰ï¼Œæ³¨æ„å½“è®¾ç½®ä¸º None æ—¶ä¸ä¼šè§¦å‘
    // PinChangeEventHandler ä¸ºå›è°ƒäº‹ä»¶
    public void RegisterCallbackForPinValueChangedEvent(int pinNumber, PinEventTypes eventTypes, PinChangeEventHandler callback);
    // ä¸ºæŒ‡å®šå¼•è„šçš„å€¼æ”¹å˜æ—¶æ³¨é”€å›è°ƒ
    public void UnregisterCallbackForPinValueChangedEvent(int pinNumber, PinChangeEventHandler callback);
}
```

## äººä½“çº¢å¤–ä¼ æ„Ÿå™¨å®éªŒ

äººä½“çº¢å¤–ä¼ æ„Ÿå™¨æ˜¯åŸºäºå‘¨å›´åŒºåŸŸçš„çº¢å¤–çƒ­æ¥æ£€æµ‹è¿åŠ¨çš„ï¼Œä¹Ÿç§°è¢«åŠ¨çº¢å¤–ä¼ æ„Ÿå™¨ï¼ˆPassive Infra-Red, PIRï¼‰ã€‚è¿™é‡Œä½¿ç”¨çš„æ˜¯ HC-SR501 ã€‚å½“ä¼ æ„Ÿå™¨æ£€æµ‹åˆ°äººä½“æ—¶ï¼ŒLED å°ç¯äº®ï¼Œå½“ä¼ æ„Ÿå™¨æœªæ£€æµ‹åˆ°äººä½“æ—¶ï¼ŒLED å°ç¯ç­ã€‚

### ä¼ æ„Ÿå™¨å›¾åƒ

![2019127194134](2.jpg)
<p style="text-align:center;margin-bottom:25px;color:gray"><small>HC-SR501</small></p>

### ç¡¬ä»¶éœ€æ±‚

| åç§° | æ•°é‡ |
| :--- | ---: |
| HC-SR501 | x1 |
| LED å°ç¯ | x1 |
| 220 Î© ç”µé˜» | x1 |
| æœé‚¦çº¿ | è‹¥å¹² |

### ç”µè·¯

![2019127194548](3.png)

HC-SR501
* VCC - 5V
* GND - GND
* OUT - GPIO 17 (Pin 11)

LED
* VCC & 220 Î© resistor - GPIO 27 (Pin 14)
* GND - GND

### ä½¿ç”¨ Docker è¿è¡Œç¤ºä¾‹
ç¤ºä¾‹åœ°å€ï¼š<https://github.com/ZhangGaoxing/dotnet-core-iot-demo/tree/master/src/Hcsr501>

```
docker build -t pir-sample -f Dockerfile .
docker run --rm -it --device /dev/gpiomem pir-sample
```

### ä»£ç 

1. æ‰“å¼€ Visual Studio ï¼Œæ–°å»ºä¸€ä¸ª .NET Core æ§åˆ¶å°åº”ç”¨ç¨‹åºï¼Œé¡¹ç›®åç§°ä¸ºâ€œPIRâ€ã€‚
2. å¼•å…¥ **System.Device.Gpio** NuGet åŒ…ã€‚
3. æ–°å»ºç±» **Hcsr501**ï¼Œæ›¿æ¢å¦‚ä¸‹ä»£ç ï¼š

    ```C#
    public class Hcsr501 : IDisposable
    {
        private GpioController _controller;
        private readonly int _outPin;

        /// <summary>
        /// æ„é€ å‡½æ•°
        /// </summary>
        /// <param name="pin">OUT Pin</param>
        public HCSR501(int outPin, PinNumberingScheme pinNumberingScheme = PinNumberingScheme.Logical)
        {
            _outPin = outPin;

            _controller = new GpioController(pinNumberingScheme);
            _controller.OpenPin(outPin, PinMode.Input);
        }

        /// <summary>
        /// æ˜¯å¦æ£€æµ‹åˆ°äººä½“
        /// </summary>
        public bool IsMotionDetected => _controller.Read(_outPin) == PinValue.High;

        /// <summary>
        /// Cleanup
        /// </summary>
        public void Dispose()
        {
            _controller?.Dispose();
            _controller = null;
        }
    }
    ```

4. åœ¨ **Program.cs** ä¸­ï¼Œå°†ä¸»å‡½æ•°ä»£ç æ›¿æ¢å¦‚ä¸‹ï¼š

    ```C#
    static void Main(string[] args)
    {
        // HC-SR501 OUT Pin
        int hcsr501Pin = 17;
        // LED Pin
        int ledPin = 27;

        // è·å– GPIO æ§åˆ¶å™¨
        using GpioController ledController = new GpioController(PinNumberingScheme.Logical);
        // åˆå§‹åŒ– PIR ä¼ æ„Ÿå™¨
        using Hcsr501 sensor = new Hcsr501(hcsr501Pin, PinNumberingScheme.Logical);
        // æ‰“å¼€ LED å¼•è„š
        ledController.OpenPin(ledPin, PinMode.Output);

        while (true)
        {
            // æ£€æµ‹åˆ°äº†äººä½“
            if (sensor.IsMotionDetected == true)
            {
                ledController.Write(ledPin, PinValue.High);
                Console.WriteLine("Detected! Turn the LED on.");
            }
            else
            {
                ledController.Write(ledPin, PinValue.Low);
                Console.WriteLine("Undetected! Turn the LED off.");
            }

            Thread.Sleep(1000);
        }
    }
    ```

5. å‘å¸ƒã€æ‹·è´ã€æ›´æ”¹æƒé™ã€è¿è¡Œ

### æ•ˆæœå›¾

![2019127201429](5.gif)

![2019127201511](4.jpg)

<div style="display: block;position: relative;border-radius: 8px;padding: 1rem;background-color: #d2f9d2;color: #094409;margin: 10px">
    <p style="margin-top:0;font-weight: bold">ğŸ’¡&nbsp;å¦‚ä½•æ”¹è¿›ï¼Ÿ</p>
    <p><span>å‰”é™¤ä¸»å‡½æ•°å¾ªç¯ï¼Œå°è¯•ä½¿ç”¨ RegisterCallbackForPinValueChangedEvent() æ³¨å†Œä¸€ä¸ªå›è°ƒè¿›è¡Œæ£€æµ‹ã€‚</span></p>
</div>

## å‚è€ƒ
1. General-purpose input/output - Wikipediaï¼š<https://en.wikipedia.org/wiki/General-purpose_input/output>
2. GPIO - Raspberry Pi Documentationï¼š<https://www.raspberrypi.org/documentation/usage/gpio/>
3. GPIO source codeï¼š<https://github.com/dotnet/iot/tree/master/src/System.Device.Gpio/System/Device/Gpio>